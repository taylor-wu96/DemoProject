<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>夜都市環境音樂生成器</title>
    <script src="./tone.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a2e 30%,
          #16213e 70%,
          #0f3460 100%
        );
        color: #e0e0e0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
      }

      .title {
        text-align: center;
        font-size: 2.8rem;
        font-weight: 100;
        letter-spacing: 4px;
        margin: 40px 0;
        background: linear-gradient(45deg, #4a90e2, #7b68ee, #4a90e2);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
        animation: glow 4s ease-in-out infinite alternate;
      }

      @keyframes glow {
        0% {
          filter: brightness(1);
        }
        100% {
          filter: brightness(1.2);
        }
      }

      .subtitle {
        text-align: center;
        font-size: 1.2rem;
        color: #888;
        margin-bottom: 50px;
        font-weight: 300;
        letter-spacing: 2px;
      }

      .main-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 60px;
        flex-wrap: wrap;
      }

      .main-button {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        border: none;
        color: white;
        padding: 18px 40px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 300;
        letter-spacing: 1px;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 8px 25px rgba(46, 82, 152, 0.3);
        position: relative;
        overflow: hidden;
      }

      .main-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .main-button:hover::before {
        left: 100%;
      }

      .main-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(46, 82, 152, 0.4);
      }

      .main-button.playing {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        50% {
          box-shadow: 0 8px 35px rgba(102, 126, 234, 0.6);
        }
      }

      .layers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 50px;
      }

      .layer-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .layer-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(74, 144, 226, 0.1) 0%,
          transparent 50%
        );
        transform: scale(0);
        transition: transform 0.6s ease;
      }

      .layer-card:hover::before {
        transform: scale(1);
      }

      .layer-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(74, 144, 226, 0.3);
      }

      .layer-title {
        font-size: 1.3rem;
        margin-bottom: 20px;
        color: #4a90e2;
        font-weight: 300;
        position: relative;
        z-index: 2;
      }

      .control-group {
        margin-bottom: 20px;
        position: relative;
        z-index: 2;
      }

      .control-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        color: #bbb;
        font-size: 0.95rem;
      }

      .control-value {
        color: #4a90e2;
        font-weight: 500;
      }

      .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        transition: all 0.3s ease;
      }

      .slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a90e2, #7b68ee);
        cursor: pointer;
        box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        transition: all 0.2s ease;
      }

      .slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      .toggle-button {
        background: rgba(74, 144, 226, 0.2);
        border: 1px solid rgba(74, 144, 226, 0.4);
        color: #4a90e2;
        padding: 8px 16px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .toggle-button.active {
        background: linear-gradient(135deg, #4a90e2, #7b68ee);
        color: white;
        box-shadow: 0 0 15px rgba(74, 144, 226, 0.4);
      }

      .visualizer {
        height: 150px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        margin: 30px 0;
        border: 1px solid rgba(74, 144, 226, 0.2);
        position: relative;
        overflow: hidden;
      }

      .frequency-bar {
        position: absolute;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to top, #4a90e2, #7b68ee);
        border-radius: 2px 2px 0 0;
        opacity: 0.7;
        animation: frequency 2s ease-in-out infinite alternate;
      }

      @keyframes frequency {
        0% {
          height: 20%;
        }
        100% {
          height: 60%;
        }
      }

      .atmosphere-text {
        text-align: center;
        font-size: 1.1rem;
        color: #888;
        margin: 40px 0;
        line-height: 1.6;
        font-style: italic;
      }

      .presets {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 40px;
      }

      .preset-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ccc;
        padding: 15px 20px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .preset-button:hover {
        background: rgba(74, 144, 226, 0.2);
        border-color: rgba(74, 144, 226, 0.4);
        color: #4a90e2;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">夜都市環境音樂</h1>
      <p class="subtitle">基於Takashi Kokubo & Brian Eno風格的即時生成</p>

      <div class="main-controls">
        <button id="playBtn" class="main-button">▶ 開始音樂之旅</button>
        <button id="stopBtn" class="main-button">⏹ 停止</button>
        <button id="regenerateBtn" class="main-button">🔄 重新生成</button>
      </div>

      <div class="visualizer" id="visualizer"></div>

      <div class="layers-grid">
        <div class="layer-card">
          <h3 class="layer-title">🌊 深層襯墊</h3>
          <div class="control-group">
            <div class="control-label">
              <span>音量</span>
              <span class="control-value" id="padVolume">65</span>
            </div>
            <input
              type="range"
              class="slider"
              id="padVol"
              min="0"
              max="100"
              value="65" />
          </div>
          <div class="control-group">
            <div class="control-label">
              <span>濾波器</span>
              <span class="control-value" id="padFilter">40</span>
            </div>
            <input
              type="range"
              class="slider"
              id="padFilt"
              min="0"
              max="100"
              value="40" />
          </div>
          <button class="toggle-button" id="padToggle">啟用</button>
        </div>

        <div class="layer-card">
          <h3 class="layer-title">🎵 稀疏旋律</h3>
          <div class="control-group">
            <div class="control-label">
              <span>音量</span>
              <span class="control-value" id="melodyVolume">45</span>
            </div>
            <input
              type="range"
              class="slider"
              id="melodyVol"
              min="0"
              max="100"
              value="45" />
          </div>
          <div class="control-group">
            <div class="control-label">
              <span>稀疏度</span>
              <span class="control-value" id="melodyDensity">25</span>
            </div>
            <input
              type="range"
              class="slider"
              id="melodyDens"
              min="0"
              max="100"
              value="25" />
          </div>
          <button class="toggle-button" id="melodyToggle">啟用</button>
        </div>

        <div class="layer-card">
          <h3 class="layer-title">🎺 持續音</h3>
          <div class="control-group">
            <div class="control-label">
              <span>音量</span>
              <span class="control-value" id="droneVolume">55</span>
            </div>
            <input
              type="range"
              class="slider"
              id="droneVol"
              min="0"
              max="100"
              value="55" />
          </div>
          <div class="control-group">
            <div class="control-label">
              <span>音高漂移</span>
              <span class="control-value" id="droneDrift">30</span>
            </div>
            <input
              type="range"
              class="slider"
              id="droneDrft"
              min="0"
              max="100"
              value="30" />
          </div>
          <button class="toggle-button active" id="droneToggle">啟用</button>
        </div>

        <div class="layer-card">
          <h3 class="layer-title">🌫️ 環境質感</h3>
          <div class="control-group">
            <div class="control-label">
              <span>混響</span>
              <span class="control-value" id="reverbAmount">75</span>
            </div>
            <input
              type="range"
              class="slider"
              id="reverbAmt"
              min="0"
              max="100"
              value="75" />
          </div>
          <div class="control-group">
            <div class="control-label">
              <span>延遲</span>
              <span class="control-value" id="delayAmount">35</span>
            </div>
            <input
              type="range"
              class="slider"
              id="delayAmt"
              min="0"
              max="100"
              value="35" />
          </div>
          <button class="toggle-button active" id="fxToggle">啟用</button>
        </div>
      </div>

      <div class="atmosphere-text">
        "在夜晚的都市中，每一束光都訴說著一個故事，每一個陰影都蘊含著無限的可能..."
      </div>

      <div class="presets">
        <button class="preset-button" onclick="loadPreset('solitude')">
          🌙 孤獨夜晚
        </button>
        <button class="preset-button" onclick="loadPreset('mystery')">
          🌃 城市之謎
        </button>
        <button class="preset-button" onclick="loadPreset('contemplation')">
          🧘 深度沉思
        </button>
        <button class="preset-button" onclick="loadPreset('distant')">
          ✨ 遠方燈火
        </button>
      </div>
    </div>

    <script>
      // Global audio objects
      let audioContext;
      let isPlaying = false;
      let synths = {};
      let effects = {};
      let sequences = {};
      let layers = {
        pad: true,
        melody: false,
        drone: true,
        fx: true,
      };

      // Musical scales and progressions for night atmosphere
      const nightChords = [
        ["A3", "C4", "E4", "G4"], // Am7
        ["F3", "A3", "C4", "E4"], // Fmaj7
        ["C3", "E3", "G3", "B3"], // Cmaj7
        ["G3", "B3", "D4", "F#4"], // G7
        ["D3", "F#3", "A3", "C4"], // Dm7
        ["E3", "G#3", "B3", "D4"], // E7
      ];

      const melodyNotes = ["A4", "C5", "E5", "F5", "G5", "A5", "C6"];
      const droneNotes = ["A1", "E2", "A2"];

      async function initializeAudio() {
        await Tone.start();

        // Create effects chain
        effects.reverb = new Tone.Reverb(6).toDestination();
        effects.delay = new Tone.PingPongDelay("8n", 0.2).connect(
          effects.reverb
        );
        effects.filter = new Tone.Filter(800, "lowpass").connect(effects.delay);

        // Create synthesizers
        synths.pad = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: "sawtooth" },
          envelope: { attack: 8, decay: 0.1, sustain: 0.9, release: 12 },
          filter: { frequency: 1000, rolloff: -24, Q: 1 },
        }).connect(effects.filter);

        synths.melody = new Tone.Synth({
          oscillator: { type: "sine" },
          envelope: { attack: 3, decay: 2, sustain: 0.3, release: 8 },
          filter: { frequency: 2000, rolloff: -12 },
        }).connect(effects.reverb);

        synths.drone = new Tone.Synth({
          oscillator: { type: "triangle" },
          envelope: { attack: 12, decay: 0, sustain: 1, release: 15 },
          filter: { frequency: 400, rolloff: -24 },
        }).connect(effects.filter);

        // Set initial volumes
        synths.pad.volume.value = -15;
        synths.melody.volume.value = -20;
        synths.drone.volume.value = -18;

        updateVisualization();
      }

      function createPadSequence() {
        let chordIndex = 0;
        sequences.pad = new Tone.Loop((time) => {
          if (layers.pad) {
            const chord = nightChords[chordIndex % nightChords.length];
            synths.pad.triggerAttackRelease(chord, "2m", time);
            chordIndex++;
          }
        }, "4m");
        sequences.pad.start(0);
      }

      function createMelodySequence() {
        sequences.melody = new Tone.Loop((time) => {
          if (layers.melody) {
            const density =
              parseInt(document.getElementById("melodyDens").value) / 100;
            if (Math.random() < density * 0.4) {
              const note =
                melodyNotes[Math.floor(Math.random() * melodyNotes.length)];
              const duration = Math.random() > 0.5 ? "2n" : "4n";
              synths.melody.triggerAttackRelease(note, duration, time);
            }
          }
        }, "1m");
        sequences.melody.start(0);
      }

      function createDroneSequence() {
        let droneIndex = 0;
        sequences.drone = new Tone.Loop((time) => {
          if (layers.drone) {
            synths.drone.triggerRelease(time);
            const note = droneNotes[droneIndex % droneNotes.length];
            synths.drone.triggerAttack(note, time + 0.1);
            droneIndex++;
          }
        }, "8m");
        sequences.drone.start(0);
      }

      async function startMusic() {
        if (isPlaying) return;

        await initializeAudio();

        isPlaying = true;
        document.getElementById("playBtn").textContent = "⏸ 暫停";
        document.getElementById("playBtn").classList.add("playing");

        // Create sequences
        createPadSequence();
        createMelodySequence();
        createDroneSequence();

        // Start transport
        Tone.Transport.bpm.value = 40;
        Tone.Transport.start();

        // Start drone immediately
        if (layers.drone) {
          synths.drone.triggerAttack("A1");
        }
      }

      function stopMusic() {
        if (!isPlaying) return;

        isPlaying = false;
        document.getElementById("playBtn").textContent = "▶ 開始音樂之旅";
        document.getElementById("playBtn").classList.remove("playing");

        Tone.Transport.stop();

        // Stop all sequences
        Object.values(sequences).forEach((seq) => {
          if (seq) seq.stop();
        });

        // Release all notes
        Object.values(synths).forEach((synth) => {
          if (synth.releaseAll) synth.releaseAll();
          if (synth.triggerRelease) synth.triggerRelease();
        });
      }

      function regenerateMusic() {
        if (isPlaying) {
          stopMusic();
          setTimeout(startMusic, 100);
        }
      }

      function updateVisualization() {
        const visualizer = document.getElementById("visualizer");
        visualizer.innerHTML = "";

        for (let i = 0; i < 50; i++) {
          const bar = document.createElement("div");
          bar.className = "frequency-bar";
          bar.style.left = i * 2 + 5 + "%";
          bar.style.animationDelay = i * 0.1 + "s";
          bar.style.animationDuration = 2 + Math.random() * 3 + "s";
          visualizer.appendChild(bar);
        }
      }

      function updateAudio() {
        if (!isPlaying) return;

        // Update volumes
        const padVol = parseInt(document.getElementById("padVol").value);
        const melodyVol = parseInt(document.getElementById("melodyVol").value);
        const droneVol = parseInt(document.getElementById("droneVol").value);

        synths.pad.volume.value = -30 + padVol * 0.2;
        synths.melody.volume.value = -35 + melodyVol * 0.25;
        synths.drone.volume.value = -35 + droneVol * 0.2;

        // Update filter
        const filterFreq = parseInt(document.getElementById("padFilt").value);
        effects.filter.frequency.value = 200 + filterFreq * 15;

        // Update reverb
        const reverbAmt =
          parseInt(document.getElementById("reverbAmt").value) / 100;
        effects.reverb.wet.value = reverbAmt * 0.8;

        // Update delay
        const delayAmt =
          parseInt(document.getElementById("delayAmt").value) / 100;
        effects.delay.wet.value = delayAmt * 0.4;
      }

      function toggleLayer(layerName) {
        layers[layerName] = !layers[layerName];
        const button = document.getElementById(layerName + "Toggle");
        button.classList.toggle("active");
        button.textContent = layers[layerName] ? "啟用" : "停用";
      }

      function loadPreset(presetName) {
        const presets = {
          solitude: {
            padVol: 80,
            padFilt: 30,
            melodyVol: 20,
            melodyDens: 15,
            droneVol: 70,
            droneDrft: 20,
            reverbAmt: 85,
            delayAmt: 25,
          },
          mystery: {
            padVol: 60,
            padFilt: 60,
            melodyVol: 40,
            melodyDens: 35,
            droneVol: 50,
            droneDrft: 50,
            reverbAmt: 90,
            delayAmt: 60,
          },
          contemplation: {
            padVol: 90,
            padFilt: 20,
            melodyVol: 30,
            melodyDens: 20,
            droneVol: 60,
            droneDrft: 15,
            reverbAmt: 75,
            delayAmt: 30,
          },
          distant: {
            padVol: 50,
            padFilt: 70,
            melodyVol: 15,
            melodyDens: 10,
            droneVol: 80,
            droneDrft: 40,
            reverbAmt: 95,
            delayAmt: 50,
          },
        };

        const preset = presets[presetName];
        if (!preset) return;

        Object.entries(preset).forEach(([key, value]) => {
          const element = document.getElementById(key);
          const display = document.getElementById(
            key
              .replace(/([A-Z])/g, "$1")
              .replace(
                /^./,
                (m) => m.charAt(0).toUpperCase() + m.slice(1).toLowerCase()
              )
          );

          if (element) {
            element.value = value;
            if (display) display.textContent = value;
          }
        });

        updateAudio();
      }

      // Event listeners
      document.getElementById("playBtn").addEventListener("click", () => {
        isPlaying ? stopMusic() : startMusic();
      });

      document.getElementById("stopBtn").addEventListener("click", stopMusic);
      document
        .getElementById("regenerateBtn")
        .addEventListener("click", regenerateMusic);

      // Layer toggles
      ["pad", "melody", "drone", "fx"].forEach((layer) => {
        const button = document.getElementById(layer + "Toggle");
        if (button) {
          button.addEventListener("click", () => toggleLayer(layer));
        }
      });

      // Slider updates
      const sliderMappings = {
        padVol: "padVolume",
        padFilt: "padFilter",
        melodyVol: "melodyVolume",
        melodyDens: "melodyDensity",
        droneVol: "droneVolume",
        droneDrft: "droneDrift",
        reverbAmt: "reverbAmount",
        delayAmt: "delayAmount",
      };

      Object.entries(sliderMappings).forEach(([sliderId, displayId]) => {
        const slider = document.getElementById(sliderId);
        const display = document.getElementById(displayId);

        if (slider && display) {
          slider.addEventListener("input", (e) => {
            display.textContent = e.target.value;
            updateAudio();
          });
        }
      });

      // Initialize visualization on load
      window.addEventListener("load", updateVisualization);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Solar Wind Archiveï½œå¤ªé™½é¢¨è¨˜æ†¶é«”</title>
    <script src="./p5.min.js"></script>
    <script src="./p5.sound.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: "Helvetica Neue", sans-serif;
      }
      #overlay {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        z-index: 10;
      }
      #overlay h1 {
        margin: 0 0 10px;
        font-size: 1.5em;
        color: #ffcc99;
      }
      #overlay p {
        font-size: 0.9em;
        color: #cccccc;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <h1>å¤ªé™½é¢¨è¨˜æ†¶é«”ï½œSolar Wind Archive</h1>
      <p>ğŸ–¼ï¸ è«‹å°‡ä½ çš„åœ–åƒæ‹–æ›³é€²ç•«é¢<br />åœ¨æ—¥å†•é¢¨ä¸­ï¼Œè¨˜æ†¶å°‡è¢«é‡‹æ”¾</p>
    </div>

    <script>
      let img, vid, gfx;
      let particles = [];
      let baseWind = 0.00005; // åŸºç¤å¾®é¢¨å¼·åº¦
      let windStrength = baseWind;
      let imgSize = 500;
      let passCount = 0;

      let song; // èƒŒæ™¯éŸ³æ¨‚
      let amp; // æŒ¯å¹…åˆ†æå™¨

      function preload() {
        // è¼‰å…¥èƒŒæ™¯éŸ³æ¨‚ï¼ˆæ”¾åœ¨å°ˆæ¡ˆåŒç›®éŒ„æˆ–æŒ‡å®šå®Œæ•´è·¯å¾‘ï¼‰
        song = loadSound("./sound.mp3");
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);
        pixelDensity(1);
        imageMode(CENTER);
        background(0);
        // æŒ¯å¹…åˆ†æå™¨
        amp = new p5.Amplitude();
        amp.setInput(song);

        // æ’­æ”¾éŸ³æ¨‚

        gfx = createGraphics(imgSize, imgSize);
        let dropZone = select("canvas");
        dropZone.drop(gotFile);
      }

      function gotFile(file) {
        img = vid = null;
        particles = [];
        userStartAudio().then(() => {
          if (!song.isPlaying()) {
            song.loop();
          }
        });

        if (file.type === "video") {
          vid = createVideo([file.data], () => {
            vid.volume(1);
            vid.hide();
            // å…ˆä¸è¦ç”¨ loopï¼Œæ”¹ç”¨ play + onended callback
            vid.onended(() => {
              passCount++;
              // é‡è¨­ç²’å­ï¼Œä»¥ä¾¿ç¬¬äºŒéæœ‰å…¨æ–°æ¨£è²Œ
              // particles = [];
              // ç¬¬äºŒéé–‹å§‹ï¼šå•Ÿå‹• loop
              vid.play();
            });
            vid.play();
            // èª¿æ•´ gfx å¤§å°
            let w = vid.width,
              h = vid.height;
            if (w > h) {
              vid.size(imgSize, (h * imgSize) / w);
            } else {
              vid.size((w * imgSize) / h, imgSize);
            }
            gfx.resizeCanvas(vid.width, vid.height);
          });
        }
      }

      function draw() {
        background(0, 20);
        if (passCount >= 1) {
          // é€éæŒ¯å¹…å–å¾—éŸ³é‡å¼·åº¦
          let level = amp.getLevel(); // 0.0 ~ 1.0
          // å°‡éŸ³é‡å°æ˜ åˆ°é¢¨å¼·åº¦ç¯„åœ
          windStrength = map(level, 0, 0.3, baseWind, 0.001 * passCount, true);
        }
        if (img || (vid && vid.loadedmetadata)) {
          gfx.clear();
          if (img) {
            gfx.image(img, gfx.width / 2, gfx.height / 2);
          } else {
            gfx.image(
              vid,
              gfx.width / 2,
              gfx.height / 2,
              gfx.width,
              gfx.height
            );
          }
          gfx.loadPixels();

          let idx = 0;
          for (let y = 0; y < gfx.height; y += 2) {
            for (let x = 0; x < gfx.width; x += 2) {
              let i = (x + y * gfx.width) * 4;
              let c = color(
                gfx.pixels[i],
                gfx.pixels[i + 1],
                gfx.pixels[i + 2]
              );
              if (particles[idx]) {
                particles[idx].color = c;
                // ç¬¬äºŒéï¼ˆpassCount >=1ï¼‰æ‰ç”¨å¤ªé™½é¢¨; ç¬¬ä¸€éé¢¨åŠ›è¨­ç‚ºæ¥µå°
                particles[idx].resetWind(
                  passCount >= 1 ? windStrength : 0.0012
                );
              } else {
                let px = x + width / 2 - gfx.width / 2;
                let py = y + height / 2 - gfx.height / 2;
                particles.push(
                  new Particle(
                    px,
                    py,
                    c,
                    passCount >= 1 ? windStrength : 0.0001
                  )
                );
              }
              idx++;
            }
          }
          particles.splice(idx);
        }

        for (let p of particles) {
          p.update();
          p.display();
        }
      }

      class Particle {
        constructor(x, y, col, w) {
          this.pos = createVector(x, y);
          this.vel = createVector(random(-0.05, 0.05), random(-0.05, 0.05));
          this.color = col;
          this.alpha = 255;
          this.size = random(1.5, 3);
          this.decay = random(0.0001, 0.0003);
          this.resetWind(w);
        }

        resetWind(strength) {
          // åˆ©ç”¨ noise æ±ºå®šæ–¹å‘ï¼Œå†ä¹˜ä»¥å‚³å…¥ strength
          let angle =
            noise(this.pos.x * 0.005, this.pos.y * 0.005, frameCount * 0.005) *
            TWO_PI *
            2;
          this.acc = p5.Vector.fromAngle(angle).mult(strength);
        }

        update() {
          this.vel.add(this.acc);
          this.pos.add(this.vel);
          this.acc.mult(this.decay);
          this.alpha -= 0.03;
        }

        display() {
          noStroke();

          if (passCount > 2) {
            // åˆ‡åˆ° HSB æ¨¡å¼æ–¹ä¾¿èª¿æ•´è‰²ç›¸
            colorMode(HSB, 360, 100, 100, 255);
            // å–å‡ºåŸå§‹é¡è‰²çš„ Hã€Sã€B
            let h = hue(this.color);
            let s = saturation(this.color);
            let b = brightness(this.color);

            // ç”¨ noise ç”¢ç”Ÿ -30 ~ +30 åº¦çš„ hue åç§»
            let t = frameCount * 0.005; // æ§åˆ¶æ™‚é–“æµé€Ÿ
            let n = noise(this.pos.x * 0.01, this.pos.y * 0.01, t);
            let shift = map(n, 0, 1, -45, 45);

            // è¨ˆç®—æ–°é¡è‰²ä¸¦ç¹ªè£½
            let dynamicColor = color((h + shift + 360) % 360, s, b, this.alpha);
            fill(dynamicColor);

            // åˆ‡å› RGB æ¨¡å¼ï¼Œé¿å…å½±éŸ¿å…¨åŸŸ
            colorMode(RGB, 255, 255, 255, 255);
          } else {
            // passCount <= 2 æ™‚ä¿æŒåŸè‰²
            fill(
              red(this.color),
              green(this.color),
              blue(this.color),
              this.alpha
            );
          }

          ellipse(this.pos.x, this.pos.y, this.size);
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
      // // å…¨åŸŸè®Šæ•¸
      // let particles = [];
      // let attractors = [];
      // const NUM_ATTRACTORS = 8; // 9 å€‹å›ºå®šçš„å¡Œé™·é»
      // let noiseScale = 0.5; // å™ªè²ç¸®æ”¾æ¯”ä¾‹ï¼Œæ§åˆ¶å¤ªé™½é¢¨çš„ç´°è†©åº¦
      // let repeller = null; // æ»‘é¼ é»æ“Šç”¢ç”Ÿçš„æ–¥åŠ›é»

      // // ç²’å­ class
      // class Particle {
      //   constructor(x, y) {
      //     this.pos = createVector(x, y);
      //     // åˆå§‹é€Ÿåº¦ï¼Œå¯ä»¥è¨­ç‚ºéš¨æ©Ÿï¼Œè®“å™´å°„æ•ˆæœæ›´è‡ªç„¶
      //     this.vel = p5.Vector.random2D().mult(random(0, 2));
      //     this.acc = createVector(0, 0);
      //     this.maxSpeed = 3; // ç²’å­çš„æœ€é«˜é€Ÿåº¦
      //     this.size = random(0.5, 4); // ç²’å­å¤§å°
      //     this.lifespan = 255; // ç”Ÿå‘½å€¼ï¼Œç”¨æ–¼æ·¡å‡ºæ•ˆæœ
      //     this.angle = random(TWO_PI);
      //     this.speed = random(0.01, 0.05); // è»Œé“æ—‹è½‰é€Ÿåº¦
      //     this.orbitRadius = random(10, 120);
      //     this.orbitingPlanet = Math.floor(random(NUM_ATTRACTORS));
      //     this.mode = 0;
      //   }

      //   // æ–½åŠ ä¸€å€‹åŠ›
      //   applyForce(force) {
      //     this.acc.add(force);
      //   }

      //   // æ›´æ–°ç²’å­çš„ç‹€æ…‹
      //   update() {
      //     this.vel.add(this.acc);
      //     this.vel.limit(this.maxSpeed);
      //     // ç¢ºä¿ orbitingPlanet ç´¢å¼•æœ‰æ•ˆä¸” attractors é™£åˆ—ä¸­å­˜åœ¨è©²å…ƒç´ åŠå…¶ pos å±¬æ€§
      //     if (
      //       this.orbitingPlanet >= 0 &&
      //       this.orbitingPlanet < attractors.length &&
      //       attractors[this.orbitingPlanet] &&
      //       attractors[this.orbitingPlanet].pos &&
      //       random() > 0.03
      //     ) {
      //       this.angle +=
      //         this.speed *
      //         attractors[this.orbitingPlanet].speedFactor *
      //         random(0.1, 0.7);
      //       let radius =
      //         (this.orbitRadius * attractors[this.orbitingPlanet].size) / 100;
      //       let x =
      //         radius *
      //           cos(
      //             this.angle *
      //               (attractors[this.orbitingPlanet].reverse ? -1 : 1)
      //           ) +
      //         attractors[this.orbitingPlanet].pos.x;
      //       let y =
      //         radius *
      //           sin(
      //             this.angle *
      //               (attractors[this.orbitingPlanet].reverse ? -1 : 1)
      //           ) +
      //         attractors[this.orbitingPlanet].pos.y;
      //       this.pos.set(x, y);

      //       if (random() < 0.03) {
      //         this.pos.add(this.vel);
      //       }
      //     } else {
      //       // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„å¸å¼•å­ï¼Œå‰‡ä½¿ç”¨ç²’å­çš„é€Ÿåº¦æ›´æ–°ä½ç½®
      //       this.pos.add(this.vel);
      //       // é‡æ–°åˆ†é…ä¸€å€‹æœ‰æ•ˆçš„å¸å¼•å­
      //       this.orbitingPlanet = Math.floor(random(attractors.length));
      //     }

      //     this.acc.mult(0);

      //     // éš¨è‘—æ™‚é–“æ…¢æ…¢æ¶ˆé€
      //     if (this.lifespan > 0.5) {
      //       this.lifespan -= 0.5;
      //     }
      //   }

      //   // é¡¯ç¤ºç²’å­
      //   display() {
      //     noStroke();
      //     // ä½¿ç”¨ lifespan æ§åˆ¶é€æ˜åº¦ï¼Œç‡Ÿé€ æ·¡å‡ºæ•ˆæœ
      //     fill(255, 255, 220, this.lifespan);
      //     ellipse(this.pos.x, this.pos.y, this.size, this.size);
      //   }

      //   // æª¢æŸ¥ç²’å­æ˜¯å¦è¶…å‡ºé‚Šç•Œ
      //   edges() {
      //     if (
      //       this.pos.x > width ||
      //       this.pos.x < 0 ||
      //       this.pos.y > height ||
      //       this.pos.y < 0
      //     ) {
      //       this.lifespan = 0; // è¶…å‡ºé‚Šç•Œçš„ç²’å­ç›´æ¥æ¨™è¨˜ç‚ºæ­»äº¡
      //     }
      //   }

      //   // æª¢æŸ¥ç²’å­æ˜¯å¦æ­»äº¡
      //   isDead() {
      //     return this.lifespan <= 0;
      //   }
      // }

      // function setup() {
      //   createCanvas(windowWidth, windowHeight);

      //   // åˆå§‹åŒ–å¸å¼•å­
      //   for (let i = 0; i < NUM_ATTRACTORS; i++) {
      //     // ç¢ºä¿æ¯å€‹å¸å¼•å­éƒ½æœ‰ pos å±¬æ€§
      //     let attractor = {
      //       pos: createVector(
      //         random(width * 0.01, width * 0.99),
      //         random(height * 0.01, height * 0.99)
      //       ),
      //       size: random(10, 200),
      //       reverse: random(1) > 0.5,
      //       speedFactor: random(0.1, 1.2),
      //     };
      //     attractors.push(attractor);
      //   }

      //   // åˆå§‹ç”Ÿæˆä¸€äº›ç²’å­
      //   for (let i = 0; i < 200; i++) {
      //     particles.push(new Particle(random(width), random(height)));
      //   }
      // }

      // function draw() {
      //   // ä½¿ç”¨åŠé€æ˜èƒŒæ™¯ä¾†è£½é€ æ‹–å½±æ•ˆæœï¼Œå½¢æˆè»Œè·¡
      //   background(0, 0, 10, 30);

      //   // éš¨æ©Ÿæ±ºå®šæ˜¯å¦å¾æŸå€‹å¡Œé™·é»å™´å°„ç²’å­
      //   if (random(1) < 0.3) {
      //     let attractor = random(attractors);
      //     if (attractor && attractor.pos) {
      //       for (let i = 0; i < 5; i++) {
      //         particles.push(new Particle(attractor.pos.x, attractor.pos.y));
      //       }
      //     }
      //   }

      //   // éæ­·æ‰€æœ‰ç²’å­
      //   for (let i = particles.length - 1; i >= 0; i--) {
      //     let p = particles[i];

      //     // 1. è¨ˆç®—ä¸¦æ–½åŠ ã€Œå¤ªé™½é¢¨ã€(Perlin Noise) çš„åŠ›
      //     let angle =
      //       noise(
      //         p.pos.x * noiseScale,
      //         p.pos.y * noiseScale,
      //         frameCount * 0.01
      //       ) *
      //       TWO_PI *
      //       2;
      //     // let noiseForce = p5.Vector.fromAngle(angle);
      //     // noiseForce.setMag(0.01);
      //     // p.applyForce(noiseForce);

      //     // 2. è¨ˆç®—ä¸¦æ–½åŠ ã€Œé‡åŠ›å¡Œé™·é»ã€çš„å¼•åŠ›
      //     attractors.forEach((attractor) => {
      //       if (attractor && attractor.pos) {
      //         let force = p5.Vector.sub(attractor.pos, p.pos).normalize();
      //         let distanceSq = constrain(force.magSq(), 25, 10000);
      //         if (distanceSq < 1000) {
      //           let strength = 100 / distanceSq; // G / d^2 (G=20)
      //           force.setMag(strength);
      //           p.applyForce(force);
      //         }
      //       }
      //     });

      //     // 3. å¦‚æœå­˜åœ¨ã€Œæ–¥åŠ›é»ã€(æ»‘é¼ é»æ“Š)ï¼Œè¨ˆç®—ä¸¦æ–½åŠ æ–¥åŠ›
      //     if (repeller) {
      //       let repelForce = p5.Vector.sub(p.pos, repeller);
      //       let d = repelForce.mag();
      //       if (d < 150) {
      //         // åªåœ¨ 150 åƒç´ ç¯„åœå…§æœ‰æ•ˆ
      //         let strength = -500 / (d * d); // æ–¥åŠ›ç‚ºè² 
      //         repelForce.setMag(strength);
      //         p.applyForce(repelForce);
      //       }
      //     }

      //     // æ›´æ–°ã€é¡¯ç¤ºä¸¦æª¢æŸ¥é‚Šç•Œ
      //     p.update();
      //     p.display();
      //     p.edges();

      //     // å¦‚æœç²’å­æ­»äº¡ï¼Œå°±å¾é™£åˆ—ä¸­ç§»é™¤
      //     if (p.isDead()) {
      //       particles.splice(i, 1);
      //     }
      //   }

      //   // å¦‚æœæ–¥åŠ›é»å­˜åœ¨ï¼Œç¹ªè£½ä¸€å€‹è¦–è¦ºæ•ˆæœä¸¦è®“å®ƒéš¨æ™‚é–“æ¶ˆå¤±
      //   if (repeller) {
      //     stroke(255, 100, 100, 100);
      //     noFill();
      //     strokeWeight(2);
      //     ellipse(repeller.x, repeller.y, 300, 300);
      //     // è®“æ–¥åŠ›é»æ•ˆæœçŸ­æš«å­˜åœ¨å¾Œæ¶ˆå¤±
      //     if (frameCount % 30 === 0) {
      //       repeller = null;
      //     }
      //   }
      // }

      // // ç•¶æ»‘é¼ æŒ‰ä¸‹æ™‚ï¼Œå‰µå»ºä¸€å€‹æ–¥åŠ›é»ï¼Œè±¡å¾µã€Œæ”¾ä¸‹ã€çš„è‡ªç”±é¸æ“‡
      // function mousePressed() {
      //   repeller = createVector(mouseX, mouseY);
      // }
    </script>
  </body>
</html>
